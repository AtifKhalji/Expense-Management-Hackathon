<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Expense Entry (With OCR)</title>
    <style>
        /* CSS STYLES */
        body { font-family: sans-serif; padding: 20px; background-color: #f4f4f9; }
        /* Navigation Bar Styles */
        .nav-bar { background-color: #333; padding: 10px 20px; margin-bottom: 20px; display: flex; justify-content: space-between; }
        .nav-bar a { color: white; text-decoration: none; margin-left: 15px; }
        .nav-bar a:hover { color: #007bff; }
        .nav-bar .admin-link { color: yellow; }
        
        .page-container { max-width: 1000px; margin: 0 auto; background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        h1, h2 { color: #007bff; margin-bottom: 15px; }
        hr { margin: 20px 0; border: 0; border-top: 1px solid #eee; }
        .form-row { display: flex; gap: 20px; margin-bottom: 20px; }
        .form-group { flex: 1; }
        label { display: block; font-weight: bold; margin-bottom: 5px; }
        input[type="text"], input[type="date"], input[type="number"], select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
        th { background-color: #f1f1f1; }
        .total-row td { font-weight: bold; background-color: #e9ecef; }
        .btn { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; color: white; }
        .btn-primary { background-color: #007bff; }
        .btn-success { background-color: #28a745; }
        .btn-danger { background-color: #dc3545; }
        .btn-sm { padding: 5px 10px; font-size: 0.9em; }
    </style>
</head>
<body>

<nav class="nav-bar">
    <div style="color: white; font-weight: bold; font-size: 1.2em;">Expense Manager ðŸ’°</div>
    <div>
        <a href="employee_entry.html">New Expense</a>
        <a href="employee_dashboard.html">My Reports</a>
        <a href="manager_dashboard.html">Manager Approvals</a>
        <span style="color: white; margin-left: 10px;">|</span>
        <a href="admin_user_management.html" class="admin-link">Admin: Users</a>
        <a href="admin_view_all.html" class="admin-link">Admin: All Expenses</a>
        <a href="admin_rules_config.html" class="admin-link">Admin: Rules</a>
    </div>
</nav>
<div class="page-container">
    <h1>New Expense Report</h1>

    <form id="reportHeaderForm">
        <h2>Report Details</h2>
        <div class="form-row">
            <div class="form-group">
                <label for="report-name">Report Name</label>
                <input type="text" id="report-name" placeholder="e.g., Q2 Travel to Chicago" required>
            </div>
            <div class="form-group">
                <label for="employee-name">Employee Name</label>
                <input type="text" id="employee-name" value="Current Employee Name" readonly>
            </div>
        </div>
        <div class="form-row">
             <div class="form-group">
                <label for="report-date">Date Created</label>
                <input type="date" id="report-date" value="2025-10-04" readonly>
            </div>
             <div class="form-group">
                <label for="report-currency">Currency (Default)</label>
                <input type="text" id="report-currency" value="USD" readonly>
            </div>
        </div>
        <button type="button" class="btn btn-primary">Save Report Header (Draft)</button>
    </form>

    <hr>

    <h2>Add New Expense Item</h2>
    <form id="addItemForm">
        <div class="form-row">
            <div class="form-group" style="flex: 2;">
                <label for="item-description">Description / Vendor</label>
                <input type="text" id="item-description" placeholder="e.g., Delta Flight, Client Lunch" required>
            </div>
            <div class="form-group">
                <label for="item-date">Date</label>
                <input type="date" id="item-date" required>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="item-category">Category</label>
                <select id="item-category" required>
                    <option value="" disabled selected>Select Category</option>
                    <option value="Travel">Travel</option>
                    <option value="Meals">Meals</option>
                    <option value="Software">Software/Tools</option>
                    <option value="Mileage">Mileage/Local Travel</option>
                </select>
            </div>
            <div class="form-group">
                <label for="item-amount">Amount (<span id="currency-symbol">USD</span>)</label>
                <input type="number" id="item-amount" min="0.01" step="0.01" placeholder="0.00" required>
            </div>
            <div class="form-group" style="flex: 2;">
                <label for="item-receipt">Receipt Upload (Optional)</label>
                <input type="file" id="item-receipt" accept="image/*, .pdf">
            </div>
            <div class="form-group" style="flex: 1;">
                <label>&nbsp;</label>
                <button type="button" class="btn btn-primary" id="scanReceiptBtn">
                    âœ¨ Scan Receipt (OCR)
                </button>
            </div>
        </div>
        
        <button type="submit" class="btn btn-success" id="addItemBtn">Add Item to Report</button>
    </form>

    <hr>

    <h2>Items in Report</h2>
    <div class="report-items-container">
        <table id="expenseItemsTable">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Category</th>
                    <th>Amount (<span id="table-currency-symbol">USD</span>)</th>
                    <th>Receipt</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="itemsTableBody">
            </tbody>
            <tfoot>
                <tr class="total-row">
                    <td colspan="3" style="text-align: right;">TOTAL REPORT AMOUNT:</td>
                    <td id="reportTotal">$0.00</td>
                    <td colspan="2"></td>
                </tr>
            </tfoot>
        </table>
    </div>
    
    <div style="text-align: right; margin-top: 20px;">
        <button type="button" class="btn btn-primary" id="submitReportBtn">SUBMIT REPORT FOR APPROVAL</button>
    </div>
</div>

<script>
    // Utility to get/set reports in Local Storage
    const getSubmittedReports = () => {
        return JSON.parse(localStorage.getItem('submittedReports')) || [];
    };

    const saveSubmittedReport = (report) => {
        const reports = getSubmittedReports();
        reports.push(report);
        localStorage.setItem('submittedReports', JSON.stringify(reports));
    };

    document.addEventListener('DOMContentLoaded', () => {
        const addItemForm = document.getElementById('addItemForm');
        const itemsTableBody = document.getElementById('itemsTableBody');
        const reportTotalElement = document.getElementById('reportTotal');
        const submitReportBtn = document.getElementById('submitReportBtn');
        const currencySymbol = document.getElementById('report-currency').value;
        const scanReceiptBtn = document.getElementById('scanReceiptBtn');

        let expenseItems = [];
        let itemCounter = 0;

        const updateReportTotal = () => {
            const total = expenseItems.reduce((sum, item) => sum + item.amount, 0);
            reportTotalElement.textContent = `${currencySymbol}${total.toFixed(2)}`;
            return total;
        };

        const renderItemsTable = () => {
            itemsTableBody.innerHTML = '';

            if (expenseItems.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `<td colspan="6" style="text-align: center; color: #999; font-style: italic;">
                    No expense items added yet.
                </td>`;
                itemsTableBody.appendChild(emptyRow);
            } else {
                expenseItems.forEach(item => {
                    const row = document.createElement('tr');
                    row.dataset.itemId = item.id;
                    
                    const receiptStatus = item.receiptName ? 
                        `<span style="color: green;">âœ” Attached (${item.receiptName.substring(0, 10)}...)</span>` : 
                        `<span style="color: gray;">No</span>`;

                    row.innerHTML = `
                        <td>${item.date}</td>
                        <td>${item.description}</td>
                        <td>${item.category}</td>
                        <td>${currencySymbol}${item.amount.toFixed(2)}</td>
                        <td>${receiptStatus}</td>
                        <td>
                            <button class="btn btn-danger btn-sm delete-item-btn" data-id="${item.id}">Delete</button>
                        </td>
                    `;
                    itemsTableBody.appendChild(row);
                });
            }
            updateReportTotal();
        };
        
        // --- OCR Simulation Function ---
        const simulateOCR = () => {
            const receiptFile = document.getElementById('item-receipt').files[0];
            
            if (!receiptFile) {
                alert("Please select an image or PDF file first to simulate OCR.");
                return;
            }

            // Simulated OCR Output Data
            const ocrResult = {
                amount: 45.75,
                date: "2025-10-04",
                vendor: "The Burger Shack",
                category: "Meals",
                description: "Client lunch with Acme team."
            };

            // Auto-populate the form fields
            document.getElementById('item-amount').value = ocrResult.amount.toFixed(2);
            document.getElementById('item-date').value = ocrResult.date;
            document.getElementById('item-description').value = ocrResult.vendor + " - " + ocrResult.description;
            document.getElementById('item-category').value = ocrResult.category;
            
            alert(`OCR successful! Expense details for ${ocrResult.vendor} ($${ocrResult.amount.toFixed(2)}) auto-populated.`);
        };
        // End OCR Simulation

        addItemForm.addEventListener('submit', (e) => {
            e.preventDefault();

            const amountValue = parseFloat(document.getElementById('item-amount').value);
            const receiptFile = document.getElementById('item-receipt').files[0];

            if (isNaN(amountValue) || amountValue <= 0) {
                alert("Please enter a valid expense amount.");
                return;
            }

            const newItem = {
                id: ++itemCounter,
                date: document.getElementById('item-date').value,
                description: document.getElementById('item-description').value,
                category: document.getElementById('item-category').value,
                amount: amountValue,
                receiptName: receiptFile ? receiptFile.name : null
            };

            expenseItems.push(newItem);
            renderItemsTable();

            addItemForm.reset();
            document.getElementById('item-date').value = '';
        });

        itemsTableBody.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-item-btn')) {
                const itemId = parseInt(e.target.dataset.id);
                
                expenseItems = expenseItems.filter(item => item.id !== itemId);
                
                renderItemsTable();
            }
        });

        submitReportBtn.addEventListener('click', () => {
            const reportName = document.getElementById('report-name').value.trim();
            const employeeName = document.getElementById('employee-name').value;
            const totalAmount = updateReportTotal();

            if (!reportName) {
                 alert("Please enter a name for your expense report.");
                 return;
            }

            if (expenseItems.length === 0) {
                alert("Please add at least one expense item before submitting.");
                return;
            }
            
            // Generate a unique report ID for persistence
            const reportId = Date.now();
            const dateCreated = document.getElementById('report-date').value;

            // Report object to save
            const finalReport = {
                id: reportId,
                employee: employeeName,
                name: reportName,
                date: dateCreated,
                amount: totalAmount,
                status: "Pending", // Always Pending upon submission
                items: expenseItems
            };

            // Save to Local Storage (making it available for Manager Dashboard)
            saveSubmittedReport(finalReport);

            alert(`
SUCCESS! Report Submitted.
-------------------------------------
Report Name: ${reportName}
Total: ${currencySymbol}${totalAmount.toFixed(2)}
Items: ${expenseItems.length}

This report is now visible on the Manager's Approval Dashboard.
            `);

            // Reset form and items
            document.getElementById('reportHeaderForm').reset();
            expenseItems = [];
            renderItemsTable();
        });

        scanReceiptBtn.addEventListener('click', simulateOCR);
        renderItemsTable();
    });
</script>
</body>
</html>
